<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weave</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://npmcdn.com/parse/dist/parse.min.js"></script>

<style>
  body { background:#f3f4f6; color:#111; }
  body.dark-mode { background:#181818; color:#e5e5e5; }
  body.dark-mode nav { background:#202020; }
  body.dark-mode .card { background:#242424; }
  body.dark-mode input, body.dark-mode textarea {
    background:#2a2a2a; color:#e5e5e5; border-color:#444;
  }
</style>
</head>

<body class="font-sans">

<div class="flex min-h-screen">

<nav class="w-64 p-6 flex flex-col space-y-4 shadow card">
  <h1 class="text-2xl font-bold">Weave</h1>
  <button onclick="showFeed()" class="p-2 rounded hover:bg-gray-200">Home</button>
  <button onclick="openNotifications()" class="p-2 rounded hover:bg-gray-200">Notifications</button>
  <button onclick="showProfile()" class="p-2 rounded hover:bg-gray-200">Profile</button>
  <button onclick="openSettings()" class="p-2 rounded hover:bg-gray-200">Settings</button>
  <button onclick="logout()" class="p-2 rounded text-red-500">Logout</button>
</nav>

<main class="flex-1 p-6">

<div id="feedPage">
  <div class="card rounded-xl p-4 mb-4 shadow">
    <textarea id="newPost" class="w-full p-2 border rounded mb-2" placeholder="Whatâ€™s happening?"></textarea>
    <button onclick="createPost()" class="bg-blue-500 text-white px-4 py-2 rounded">Post</button>
  </div>
  <div id="feed" class="space-y-4"></div>
</div>

<div id="profilePage" class="hidden">
  <h2 class="text-2xl font-bold mb-2">Profile</h2>
  <p>@<span id="profileUsername"></span></p>
</div>

</main>
</div>

<div id="notificationsModal" class="fixed inset-0 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="card p-6 rounded-xl w-96 relative">
    <h2 class="text-xl font-bold mb-2">Notifications</h2>
    <div>Nothing yet ðŸ‘€</div>
    <button onclick="closeNotifications()" class="absolute top-2 right-2">âœ–</button>
  </div>
</div>

<div id="settingsModal" class="fixed inset-0 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="card p-6 rounded-xl w-96 relative">
    <h2 class="text-xl font-bold mb-4">Settings</h2>
    <label class="flex items-center gap-2">
      <input type="checkbox" id="darkToggle" onchange="toggleDarkMode()"> Dark Mode
    </label>
    <button onclick="closeSettings()" class="absolute top-2 right-2">âœ–</button>
  </div>
</div>

<div id="authModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center">
  <div class="card p-6 rounded-xl w-96">
    <h2 class="text-xl font-bold mb-4">Login</h2>
    <input id="username" class="w-full p-2 border rounded mb-2" placeholder="Username">
    <input id="password" type="password" class="w-full p-2 border rounded mb-2" placeholder="Password">
    <button onclick="login()" class="w-full bg-blue-500 text-white p-2 rounded">Login</button>
  </div>
</div>

<script>
Parse.initialize("lwPJm4UFv3m4pZypU2ms9BVQvgFZ35lVOheiW9vx","MHinq9g59aQSit8lalBEYaC1MjLo8rZkhFzdqxMP");
Parse.serverURL = "https://parseapi.back4app.com/";

const feedPage = document.getElementById("feedPage");
const profilePage = document.getElementById("profilePage");
const notificationsModal = document.getElementById("notificationsModal");
const settingsModal = document.getElementById("settingsModal");
const feed = document.getElementById("feed");
const newPost = document.getElementById("newPost");
const authModal = document.getElementById("authModal");
const darkToggle = document.getElementById("darkToggle");
const profileUsername = document.getElementById("profileUsername");

function showFeed(){ feedPage.classList.remove("hidden"); profilePage.classList.add("hidden"); }
function showProfile(){ feedPage.classList.add("hidden"); profilePage.classList.remove("hidden"); }
function openNotifications(){ notificationsModal.classList.remove("hidden"); }
function closeNotifications(){ notificationsModal.classList.add("hidden"); }
function openSettings(){ settingsModal.classList.remove("hidden"); }
function closeSettings(){ settingsModal.classList.add("hidden"); }

async function toggleDarkMode(){
  document.body.classList.toggle("dark-mode");
  const user = Parse.User.current();
  if(!user) return;
  user.set("darkMode", document.body.classList.contains("dark-mode"));
  await user.save();
}

async function login(){
  await Parse.User.logIn(username.value, password.value);
  authModal.classList.add("hidden");
  loadUser();
}

function logout(){ Parse.User.logOut(); location.reload(); }

async function loadUser(){
  const user = Parse.User.current();
  if(!user) return;
  profileUsername.textContent = user.get("username");
  if(user.get("darkMode")){ document.body.classList.add("dark-mode"); darkToggle.checked = true; }
  loadPosts();
}

async function createPost(){
  const user = Parse.User.current();
  if(!user) return alert("Login first");

  const Post = Parse.Object.extend("Posts");
  const post = new Post();
  post.set("username", user.get("username"));
  post.set("content", newPost.value);
  await post.save();

  newPost.value = "";
  loadPosts();
}

/* ---------- COMMENTS ---------- */

async function addComment(postId, input){
  const user = Parse.User.current();
  if(!user) return alert("Login first");

  const Comment = Parse.Object.extend("Comments");
  const comment = new Comment();
  comment.set("username", user.get("username"));
  comment.set("content", input.value);

  const Post = Parse.Object.extend("Posts");
  const post = new Post();
  post.id = postId;
  comment.set("post", post);

  await comment.save();
  loadPosts();
}

async function loadComments(postId){
  const Comment = Parse.Object.extend("Comments");
  const query = new Parse.Query(Comment);

  const Post = Parse.Object.extend("Posts");
  const post = new Post();
  post.id = postId;

  query.equalTo("post", post);
  query.ascending("createdAt");

  return await query.find();
}

/* ---------- POSTS ---------- */

async function loadPosts(){
  feed.innerHTML = "";
  const Post = Parse.Object.extend("Posts");
  const posts = await new Parse.Query(Post).descending("createdAt").find();
  const currentUser = Parse.User.current();
  if(!currentUser) return;

  for(const post of posts){
    const div = document.createElement("div");
    div.className = "card p-4 rounded-xl shadow";

    const comments = await loadComments(post.id);

    div.innerHTML = `
      <strong>@${post.get("username")}</strong>
      <p class="mt-2">${post.get("content")}</p>

      <div class="mt-3 space-y-1 text-sm">
        ${comments.map(c => `<div><strong>@${c.get("username")}</strong> ${c.get("content")}</div>`).join("")}
      </div>

      <div class="flex gap-2 mt-2">
        <input class="commentInput flex-1 border rounded p-1" placeholder="Write a comment...">
        <button class="bg-blue-500 text-white px-2 rounded">Reply</button>
      </div>
    `;

    const input = div.querySelector(".commentInput");
    const btn = div.querySelector("button");
    btn.onclick = () => addComment(post.id, input);

    feed.appendChild(div);
  }
}

if(Parse.User.current()){
  authModal.classList.add("hidden");
  loadUser();
}
</script>

</body>
</html>
