<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weave</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
<script>tailwind.config={darkMode:'class'}</script>
</head>

<body class="font-sans bg-white text-black dark:bg-gray-900 dark:text-white">

<div class="flex min-h-screen">

  <!-- SIDEBAR -->
  <nav class="w-64 p-6 space-y-4 shadow bg-white dark:bg-gray-800">

    <h1 class="text-2xl font-bold">Weave</h1>

    <button id="homeBtn" class="w-full text-left p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700">Home</button>

    <button id="searchToggle" class="w-full text-left p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700">üîç Search</button>

    <button id="settingsBtn" class="w-full text-left p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700">‚öôÔ∏è Settings</button>

    <button id="logoutBtn" class="w-full text-left p-2 rounded text-red-500 hover:bg-gray-200 dark:hover:bg-gray-700">Logout</button>

  </nav>

  <!-- MAIN -->
  <main class="flex-1 p-6">

    <!-- SEARCH PANEL -->
    <div id="searchPanel" class="hidden mb-4">
      <input id="searchInput" placeholder="Search usernames..."
        class="w-full p-2 border rounded bg-white dark:bg-gray-700">
      <div id="searchResults" class="mt-2 space-y-2"></div>
    </div>

    <!-- POST BOX -->
    <div class="p-4 mb-4 shadow rounded-xl bg-white dark:bg-gray-800">
      <textarea id="newPost" class="w-full p-2 border rounded mb-2 bg-white dark:bg-gray-700"
        placeholder="What‚Äôs happening?"></textarea>
      <button id="postBtn" class="bg-blue-500 text-white px-4 py-2 rounded">Post</button>
    </div>

    <div id="feed" class="space-y-4"></div>

  </main>
</div>

<!-- SETTINGS -->
<div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center">
  <div class="p-6 rounded-xl w-80 bg-white dark:bg-gray-800">

    <h2 class="text-xl font-bold mb-4">Settings</h2>

    <!-- DARK MODE -->
    <div class="flex justify-between items-center mb-4">
      <span>Dark Mode</span>
      <button id="darkToggle" class="px-3 py-1 rounded bg-gray-300 dark:bg-gray-700">Toggle</button>
    </div>

    <!-- PFP UPLOAD -->
    <div class="mb-4">
      <label class="block mb-1 font-semibold">Profile Picture</label>
      <input type="file" id="pfpUpload" accept="image/*">
      <button id="savePfp" class="mt-2 w-full bg-blue-500 text-white p-2 rounded">Save PFP</button>
    </div>

    <button id="closeSettings" class="w-full bg-gray-500 text-white p-2 rounded">Close</button>
  </div>
</div>

<!-- LOGIN -->
<div id="authModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center">
  <div class="p-6 rounded-xl w-96 bg-white dark:bg-gray-800">
    <h2 class="text-xl font-bold mb-4">Login</h2>
    <input id="username" class="w-full p-2 border rounded mb-2 dark:bg-gray-700" placeholder="Username">
    <input id="password" type="password" class="w-full p-2 border rounded mb-2 dark:bg-gray-700" placeholder="Password">
    <button id="loginBtn" class="w-full bg-blue-500 text-white p-2 rounded">Login</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

Parse.initialize("lwPJm4UFv3m4pZypU2ms9BVQvgFZ35lVOheiW9vx","MHinq9g59aQSit8lalBEYaC1MjLo8rZkhFzdqxMP");
Parse.serverURL="https://parseapi.back4app.com/";

/* ELEMENTS */
const feed=document.getElementById("feed");
const newPost=document.getElementById("newPost");
const postBtn=document.getElementById("postBtn");
const loginBtn=document.getElementById("loginBtn");
const logoutBtn=document.getElementById("logoutBtn");
const authModal=document.getElementById("authModal");

const settingsBtn=document.getElementById("settingsBtn");
const settingsModal=document.getElementById("settingsModal");
const closeSettings=document.getElementById("closeSettings");
const darkToggle=document.getElementById("darkToggle");

const pfpUpload=document.getElementById("pfpUpload");
const savePfp=document.getElementById("savePfp");

const searchToggle=document.getElementById("searchToggle");
const searchPanel=document.getElementById("searchPanel");
const searchInput=document.getElementById("searchInput");
const searchResults=document.getElementById("searchResults");

/* DARK MODE */
function setDark(enabled){
  document.documentElement.classList.toggle("dark",enabled);
  localStorage.setItem("theme",enabled?"dark":"light");
}
if(localStorage.getItem("theme")==="dark") setDark(true);
darkToggle.onclick=()=>setDark(!document.documentElement.classList.contains("dark"));

/* SETTINGS */
settingsBtn.onclick=()=>{settingsModal.classList.remove("hidden");settingsModal.classList.add("flex");}
closeSettings.onclick=()=>settingsModal.classList.add("hidden");

/* PFP UPLOAD */
savePfp.onclick=async()=>{
  const file=pfpUpload.files[0];
  if(!file) return alert("Choose an image");

  const parseFile=new Parse.File(file.name,file);
  await parseFile.save();

  const user=Parse.User.current();
  user.set("pfp",parseFile);
  await user.save();

  alert("PFP updated!");
};

/* SEARCH */
searchToggle.onclick=()=>searchPanel.classList.toggle("hidden");

searchInput.oninput=async()=>{
  const text=searchInput.value.trim();
  if(!text){searchResults.innerHTML="";return;}

  const query=new Parse.Query(Parse.User);
  query.contains("username",text);
  const results=await query.limit(5).find();

  searchResults.innerHTML="";
  results.forEach(u=>{
    const div=document.createElement("div");
    div.className="p-2 rounded bg-white dark:bg-gray-800 shadow";
    div.textContent="@"+u.get("username");
    searchResults.appendChild(div);
  });
};

/* LOGIN */
loginBtn.onclick=async()=>{
  try{
    await Parse.User.logIn(username.value,password.value);
    authModal.classList.add("hidden");
    loadPosts();
  }catch(e){alert(e.message);}
};

logoutBtn.onclick=async()=>{await Parse.User.logOut();location.reload();};

postBtn.onclick = async () => {
  try {
    const user = Parse.User.current();
    if (!user) return alert("Login first");

    const content = newPost.value.trim();
    if (!content) return alert("Post cannot be empty");

    const Post = Parse.Object.extend("Posts");
    const post = new Post();

    post.set("username", user.get("username"));
    post.set("content", content);

    const userPfp = user.get("pfp");
    if (userPfp instanceof Parse.File) {
      post.set("pfp", userPfp);
    }

    await post.save();

    newPost.value = "";
    loadPosts();

  } catch (err) {
    console.error(err);
    alert("Error posting: " + err.message);
  }
};

/* LOAD POSTS */
async function loadPosts(){
  feed.innerHTML="";
  const Post=Parse.Object.extend("Posts");
  const posts=await new Parse.Query(Post).descending("createdAt").find();

  posts.forEach(p=>{
    const pfp=p.get("pfp")?.url() || "https://placehold.co/40";

    const div=document.createElement("div");
    div.className="p-4 rounded-xl shadow bg-white dark:bg-gray-800 flex gap-3";

    div.innerHTML=`
      <img src="${pfp}" class="w-10 h-10 rounded-full object-cover">
      <div>
        <strong>@${p.get("username")}</strong>
        <p class="mt-1">${p.get("content")}</p>
      </div>
    `;
    feed.appendChild(div);
  });
}

/* AUTO LOGIN */
if(Parse.User.current()){
  authModal.classList.add("hidden");
  loadPosts();
}

});
</script>

</body>
</html>
